
<style>
  /* Sticky header */
  .table-responsive {
    max-height: 450px;
    overflow-y: auto;
  }
  thead th {
    position: sticky;
    top: 0;
    background: #212529;
    color: #fff;
    z-index: 10;
  }

  /* Zebra rows */
  tbody tr:nth-child(even) {
    background-color: #f8f9fa;
  }

  /* Highlight search matches */
  .highlight {
    background: #ffe066;
    padding: 2px 4px;
    border-radius: 4px;
  }

  /* Floating pagination bar */
  #pagination {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #dee2e6;
    padding: 6px 15px;
    border-radius: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 50;
  }

</style>

<div class="card shadow p-4 mb-5">

  <!-- TOP BAR -->
  <div class="d-flex justify-content-between flex-wrap mb-3 gap-3">

    <!-- Search -->
    <input id="searchInput" type="text" class="form-control w-auto" style="min-width:250px"
           placeholder="Search...">

    <div class="d-flex gap-2">

      <!-- Rows per page -->
      <select id="rowsSelect" class="form-select w-auto">
        <option value="5">5 rows</option>
        <option value="10" selected>10 rows</option>
        <option value="20">20 rows</option>
      </select>

      <!-- Export CSV -->
      <button id="csvExport" class="btn btn-success">
        Export CSV
      </button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-responsive border rounded">
    <table class="table table-hover table-borderless mb-0" id="mainTable">
      <thead>
        <tr>
          {{ range .headers }}
            <th class="sortable" data-key="{{ . }}" style="cursor:pointer;">
              {{ . }} <span class="opacity-50">▲▼</span>
            </th>
          {{ end }}
        </tr>
      </thead>

      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- FLOATING PAGINATION -->
  <div id="pagination" class="d-flex gap-2"></div>
</div>

<script>
(function () {

  const headers = {{ .headers | jsonify }};
  let rows = {{ .rows | jsonify }};
  let filtered = [...rows];

  const body = document.getElementById("tableBody");
  const searchInput = document.getElementById("searchInput");
  const rowsSelect = document.getElementById("rowsSelect");
  const pagination = document.getElementById("pagination");
  const exportBtn = document.getElementById("csvExport");

  let page = 1;
  let rowsPerPage = parseInt(rowsSelect.value);
  let sortKey = null;
  let sortAsc = true;

  //-------------------------------------------------------------------
  // Tamil-safe highlight
  //-------------------------------------------------------------------
  function highlight(text, query) {
    if (!query) return text;
    return text.replace(new RegExp(query, "gi"),
      match => `<span class="highlight">${match}</span>`);
  }

  //-------------------------------------------------------------------
  // Tamil sorting
  //-------------------------------------------------------------------
  function tamilSort(a, b) {
    return a.localeCompare(b, "ta", { sensitivity: "base" });
  }

  //-------------------------------------------------------------------
  // Render table
  //-------------------------------------------------------------------
  function renderTable() {
    body.innerHTML = "";
    const q = searchInput.value.trim().toLowerCase();

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageRows = filtered.slice(start, end);

    pageRows.forEach((row, i) => {
      let tr = document.createElement("tr");

      headers.forEach(h => {
        const val = row[h] || "";
        tr.innerHTML += `
          <td>${highlight(val.toString(), q)}</td>
        `;
      });

      body.appendChild(tr);
    });

    renderPagination();
  }

  //-------------------------------------------------------------------
  // Search filter
  //-------------------------------------------------------------------
  function applySearch() {
    const q = searchInput.value.toLowerCase();
    filtered = rows.filter(row =>
      Object.values(row).some(val =>
        val.toLowerCase().includes(q)
      )
    );
    page = 1;
    renderTable();
  }

  //-------------------------------------------------------------------
  // Sorting
  //-------------------------------------------------------------------
  function sortByColumn(headIndex) {
    const key = headers[headIndex];
    sortAsc = sortKey === key ? !sortAsc : true;
    sortKey = key;

    filtered.sort((a, b) => {
      const A = a[key] || "";
      const B = b[key] || "";
      const cmp = tamilSort(A, B);
      return sortAsc ? cmp : -cmp;
    });

    renderTable();
  }

  //-------------------------------------------------------------------
  // Floating pagination
  //-------------------------------------------------------------------
  function renderPagination() {
    pagination.innerHTML = "";

    const total = filtered.length;
    const pages = Math.ceil(total / rowsPerPage);

    for (let i = 1; i <= pages; i++) {
      const btn = document.createElement("button");
      btn.className =
        "btn btn-sm " +
        (i === page
          ? "btn-primary"
          : "btn-outline-secondary");

      btn.innerText = i;
      btn.onclick = () => {
        page = i;
        renderTable();
      };

      pagination.appendChild(btn);
    }
  }

  //-------------------------------------------------------------------
  // CSV Export
  //-------------------------------------------------------------------
  exportBtn.onclick = () => {
    let csv = [];
    csv.push(headers.join(","));
    rows.forEach(r => {
      csv.push(headers.map(h => `"${(r[h] || "").replace(/"/g, '""')}"`).join(","));
    });

    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "table.csv";
    a.click();
  };

  //-------------------------------------------------------------------
  // Events
  //-------------------------------------------------------------------
  searchInput.oninput = applySearch;

  rowsSelect.onchange = () => {
    rowsPerPage = parseInt(rowsSelect.value);
    renderTable();
  };

  // Sorting events
  document.querySelectorAll("th.sortable").forEach((th, i) => {
    th.onclick = () => sortByColumn(i);
  });

  //-------------------------------------------------------------------
  // INITIAL RENDER
  //-------------------------------------------------------------------
  applySearch();

})();
</script>
